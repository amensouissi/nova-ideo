<div i18n:domain="novaideo" class="content-view component-obj-view component-index-view"
     id="index_${oid}"
     data-component_type="object-view"
     tal:define="
        oid object.__oid__;
        icon getattr(object, 'icon');
        options getattr(object, 'options', []);
        selected_option object.get_selected_option(current_user)">
  <div tal:replace="structure navbar_body"/>
  <div class="media-body content-title-body">
    <h4 tal:condition="state">
      <span class="label label-basic pull-right" i18n:translate="" tal:content="state"/>
    </h4>
    <h3 class="content-title"
        data-title="${object.title}"
        data-icon="${icon}"
        data-img=""
      >
      <span tal:omit-tag="" tal:condition="not to_hide"><span class="icon ${icon}"></span> ${object.title}</span>
    </h3>
    <div class="object-description"
      tal:define="author object.author;">
     <small tal:define="author_picture getattr(author, 'picture', None)">
        <div class="author-block">
          <img class="author-img img-circle" 
             tal:condition="author_picture is not None" 
             tal:attributes="src getattr(author_picture, 'profil', author_picture).url"  width="35"/>
          <img class="author-img img-circle" tal:condition="author_picture is None" src="${request.static_url('novaideo:static/images/user100.png')}" width="35"/>
          <span>
            <span i18n:translate="">Asked by</span>
            <a tal:attributes="href request.resource_url(author, '@@index')">
              ${((author is current_user) and 'Vous') or getattr(author, 'title', author.name)}
            </a>
            <span i18n:translate="">the</span>
            <span tal:replace="layout.to_localized_time(object.created_at)"/>
          </span>
        </div>
     </small>
     <div class="keywords-result" style="margin-top: 10px">
      <span class="glyphicon glyphicon-tags"></span> 
      <tal:loop repeat="k object.keywords">
            <a tal:attributes="href request.resource_url(request.root, 'search', query={'text_to_search':k})">${k}</a><tal:separator condition="not: repeat['k'].end">, </tal:separator> 
      </tal:loop>
     </div>
    </div>
  </div>
  <div tal:condition="is_censored">
   <div class="alert-terms-of-use" i18n:translate="">
    This content does not respect the terms of use.
   </div>
  </div>
  <div tal:condition="not to_hide">
    <div tal:replace="structure support_actions_body"/>
    <div id="contenttext" class="content-text ${support_actions_body and 'row-md'}"  i18n:domain="novaideo"
      tal:define="files object.get_attached_files_data();
                  len_files len(files)">
      <div tal:omit-tag="not files">
          <div class="img-carousel-container pull-right" tal:condition="files">
              <div class="file-slider">
                <div id="filecarousel" data-ride="carousel" data-interval="3000" class="carousel slide"> 
                  <div role="listbox" class="carousel-inner">
                        <div tal:repeat="(i, source) enumerate(files)" class="item ${i==0 and 'active'}">
                           <a tal:condition="source['type'] == 'img'" href="${source['content']}" target="_blank">
                             <div 
                              class="img-content"
                              data-holder-rendered="true"
                              style="
                                background: rgba(0, 0, 0, 0) url(${source['content']}) no-repeat scroll center center / cover">
                             </div>
                           </a>
                           <object tal:condition="source['type'] == 'flash'" width="300" height="90" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=11,2,202,451" >
                            <param name="movie" value="${source['content']}">
                            <param name="quality" value="high">
                            <embed src="${source['content']}" quality="high" class="img-content" 
                              type="application/x-shockwave-flash" 
                                        pluginspage="http://www.macromedia.com/go/getflashplayer">
                            </embed>
                           </object>
                        </div>
                  </div>
                  <div tal:omit-tag="" tal:condition="len_files>1">
                    <a class="left carousel-control" href="#filecarousel" role="button" data-slide="prev">
                      <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                      <span class="sr-only">Previous</span>
                    </a>
                    <a class="right carousel-control" href="#filecarousel" role="button" data-slide="next">
                      <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                      <span class="sr-only">Next</span>
                    </a>
                  </div>
                </div>
           </div>
          </div>
          <div class="text-container" tal:omit-tag="not files">
            <div class="object-text">
              <div>
                ${structure:getattr(object, 'formatted_text', object.text)}
              </div>
              <div>
                ${structure:getattr(object, 'formatted_urls', '')}
              </div>
            </div>
          </div>
      </div>


    <div tal:condition="files" id="object_files" class="attached-files" i18n:domain="novaideo">
      <small>
       <blockquote class="attached-contents" tal:define="file_len len(files)">
         <dl>
           <dt tal:condition="file_len>1" i18n:translate="">Attachments:</dt>
           <dt tal:condition="file_len==1" i18n:translate="">Attachment:</dt>
           <dd>
              <tal:loop repeat="f layout.render_files(object.attached_files)">
                <div tal:replace="structure f"/>
              </tal:loop>
           </dd>
        </dl>
       </blockquote>
      </small>
    </div>
    <div tal:omit-tag="" tal:condition="options">
      <div tal:condition="not selected_option" class="alert alert-info">
        <p>Cette question est une question à choix suggéré. Vous pouvez faire un choix parmi ceux proposés. Vous ne pouvez répondre à cette question qu'une seule foi. Une fois répondu à cette question, vous pouvez éditer votre réponse tant que la question n'est pas clôturée.</p>
        <p>
          Les choix proposés par l'auteur sont :
          <ul>
            <li tal:repeat="option object.options"><strong>${option}</strong></li>
          </ul>
        </p>
      </div>
      <div tal:condition="selected_option" class="alert alert-info">
        <p>Cette question est une question à choix suggéré. Vous ne pouvez répondre à cette question qu'une seule foi. Vous avez déjà répondu à cette question et votre choix est "<strong>${options[selected_option]}</strong>". Vous pouvez éditer votre réponse tant que la question n'est pas clôturée.</p>
        <p>
          Les choix proposés par l'auteur sont :
          <ul>
            <li tal:repeat="option object.options"><strong>${option}</strong></li>
          </ul>
        </p>
      </div>
    </div>
   </div>
  </div>
  <div class="content-footer">
    <div class="actions-block">
        <div tal:replace="structure footer_body"/>
    </div>
  </div>
  <div class="action-interation-container action-inline-container"
     data-interaction_kind="inline">
    <div class="container-body">
    </div>
  </div>
  <div style="margin-top: 40px" tal:condition="object.answers">
    <div id="filter-results-answers-title">
      <div class="panel-title">
        <h4>${answers_title}</h4>
      </div>
    </div>
    <div class="integreted-tab-content">
      <!-- Nav tabs -->
      <ul tal:condition="options" class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active"><a href="#answers${oid}" aria-controls="answers${oid}" role="tab" data-toggle="tab"><span class="glyphicon glyphicon-saved"></span> Answers</a></li>
        <li role="presentation"><a id="stat${oid}-tab" href="#stat${oid}" aria-controls="stat${oid}" role="tab" data-toggle="tab"><span class="glyphicon glyphicon-equalizer"></span> Analytics</a></li>
      </ul>

      <!-- Tab panes -->
      <div class="tab-content">
        <div role="tabpanel" class="tab-pane active" id="answers${oid}">
          ${structure:answers_body}
        </div>
        <div tal:condition="options" role="tabpanel" class="tab-pane" id="stat${oid}">
          <div class="container-fluid analytics-container" style="max-width: 50%;">
            <div class="analytics-study-${oid}"></div>
            <canvas id="stat-canvas-${oid}" ></canvas>
            <div class="legend" id="legend-doughnut-${oid}"></div>
            <script>
              <div tal:omit-tag="" tal:define="colors layout.get_colors(len(options))">
                $('#stat${oid}-tab').on('shown.bs.tab', function (e) {
                    var doughnutData = [
                      <div tal:omit-tag="" tal:repeat="(index, item) enumerate(options)">
                          <div tal:omit-tag=""
                               tal:define="
                                  val len(object.get_user_with_option(index));
                                  glob len(object.selected_options)">
                          {
                              label: "${item}",
                              fillColor: "${colors[index]['background']}",
                              color: "${colors[index]['background']}",
                              highlight: "${colors[index]['hover']}",
                              value: ${(val*100/glob) if glob else 0}
                          },
                          </div>
                     </div>

                  ];
                  var canvas_id = "stat-canvas-${oid}"
                  var newcanvas = get_new_canvas(canvas_id);
                  $(canvas_id).replaceWith(newcanvas)
                  var ctxdoughnut = document.getElementById(canvas_id).getContext("2d");
                  ctxdoughnut.clearRect(0, 0, 500, 500);
                  var doughnut = new Chart(ctxdoughnut).Doughnut(doughnutData, {
                      responsive: true,
                      tooltipTemplate: "<%if (label){%><%=label%>: <%}%><%= value %> %",
                      generateLegend: true,
                  });
                  var doughnutlegend = doughnut.generateLegend();
                  $('.analytics-container #legend-doughnut-${oid}').html(doughnutlegend)
                })
              </div>
            </script>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>