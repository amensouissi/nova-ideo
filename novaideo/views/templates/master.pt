<!DOCTYPE html>
<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:define-macro="main"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      i18n:domain="novaideo"
      tal:define="mp request.sdiapi.mgmt_path;
      su request.static_url;
      notification_ids getattr(request.user, 'notification_ids', []);
      activate_push_notification getattr(request.root, 'activate_push_notification', False);
      app_id getattr(request.root, 'app_id', None);
      root_title getattr(request.root, 'title', '');
      view_title getattr(view, 'title', '');">
  <head >
    <meta charset="utf-8"/>
    <title metal:define-slot="page-title">${view_title if view_title else root_title}</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0"/>

    <div tal:omit-tag="" tal:condition="request.user and activate_push_notification and app_id">
      <link rel="manifest" href="${request.resource_url(request.root, 'manifest.json')}">
      <script src="${su('novaideo:static/js/OneSignalSDK.js')}" async></script>
      <script>
        var OneSignal = OneSignal || [];
        OneSignal.push(["init", {
          appId: "${app_id}",
          autoRegister: true,
          notifyButton: {
            enable: false /* Set to false to hide */
          }
        }]);
      </script>
    </div>

    ${panel('debatescore')}
    
    <script type="text/javascript" tal:condition="request.user and activate_push_notification and app_id">
        var OneSignal = OneSignal || [];
        OneSignal.getIdsAvailable(function(ids) {
          <tal:block condition="notification_ids">
            var current_ids = [${','.join(["\'"+i+"\'" for i in
                                           notification_ids]) }]
          </tal:block>
          <tal:block condition="not notification_ids">
            var current_ids = []
          </tal:block>
          if($.inArray(ids.userId, current_ids) < 0){
             update_notification_id(ids.userId,
                                    '${request.resource_url(request.root, 'novaideoapi', query={'op': 'update_notification_id'})}')
          }
        });
    </script>
    <link rel="stylesheet" href="http://cdn.materialdesignicons.com/2.1.19/css/materialdesignicons.min.css">
  </head>
  <body>
    <div id='root'></div>
    <script src="${su('novaideo:static-react/build/bundle.js')}"></script>
  </body>
</html>
